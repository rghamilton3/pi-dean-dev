- name: Install desktop prereqs
  apt:
    name:
      - libgtk-3-0
      - libnss3
      - libxss1
      - libasound2
      - xdg-utils
      - wget
      - curl
      - ca-certificates
      - gpg
    state: present
  when: install_vscode

- name: Add Microsoft apt key + repo (vscode)
  shell: |
    set -euo pipefail
    install -d -m 0755 /etc/apt/keyrings
    curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > /etc/apt/keyrings/microsoft.gpg
    chmod 0644 /etc/apt/keyrings/microsoft.gpg
  args:
    executable: /bin/bash
  when: install_vscode and (vscode_flavor == "vscode")

- name: Add VS Code repository (vscode)
  copy:
    dest: /etc/apt/sources.list.d/vscode.list
    mode: "0644"
    content: |
      deb [arch=arm64 signed-by=/etc/apt/keyrings/microsoft.gpg] https://packages.microsoft.com/repos/code stable main
  when: install_vscode and (vscode_flavor == "vscode")

- name: Add VSCodium repo key (codium)
  shell: |
    set -euo pipefail
    install -d -m 0755 /etc/apt/keyrings
    wget -qO - https://gitlab.com/paulcarroty/vscodium-deb-rpm-repo/raw/master/pub.gpg | gpg --dearmor > /etc/apt/keyrings/vscodium.gpg
    chmod 0644 /etc/apt/keyrings/vscodium.gpg
  args:
    executable: /bin/bash
  when: install_vscode and (vscode_flavor == "codium")

- name: Add VSCodium repository (codium)
  copy:
    dest: /etc/apt/sources.list.d/vscodium.list
    mode: "0644"
    content: |
      deb [arch=arm64 signed-by=/etc/apt/keyrings/vscodium.gpg] https://download.vscodium.com/debs vscodium main
  when: install_vscode and (vscode_flavor == "codium")

- name: Apt update after adding repo
  apt:
    update_cache: true
  when: install_vscode

- name: Install VS Code or Codium
  apt:
    name: "{{ 'code' if vscode_flavor == 'vscode' else 'codium' }}"
    state: present
  when: install_vscode

- name: Install PlatformIO via pipx (teen user)
  become: true
  become_user: "{{ teen_dev_user }}"
  shell: |
    set -euo pipefail
    python3 -m pip install --user --upgrade pip || true
    pipx ensurepath || true
    if command -v pio >/dev/null 2>&1; then exit 0; fi
    pipx install platformio
  args:
    executable: /bin/bash
  when: install_platformio
